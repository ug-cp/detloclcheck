variables:
  DEBIAN_FRONTEND: noninteractive
  APT_GET_INSTALL: "apt-get install --no-install-recommends -q -y"

stages:
  - pre
  - build_test
  - deploy

.display_env:
  before_script:
    - date
    - uname -a
    - cat /etc/os-release

pre-commit:
  stage: pre
  image:
    name: alpine:edge
  extends: .display_env
  script:
    - apk add --no-cache git npm pre-commit shellcheck
    - pre-commit --version
    - pre-commit run --all-files
    - CREATED_SCRIPTS=$(mktemp -d)
    - |
      JOBNAMES="$(mktemp)"
      grep -E "^([^ ]+):$" < .gitlab-ci.yml | sed 's/://' > "$JOBNAMES"
      while IFS= read -r jobname
      do
        ./yaml2script.py .gitlab-ci.yml "$jobname" | tee "$CREATED_SCRIPTS/$jobname"
      done < "$JOBNAMES"
      rm "$JOBNAMES"
    - shellcheck -e SC2154 "$CREATED_SCRIPTS"/*

pycodestyle:
  stage: pre
  image:
    name: alpine:latest
  extends: .display_env
  script:
    - apk add --no-cache py3-pycodestyle
    - pycodestyle --version
    - pycodestyle --show-source --show-pep8 --statistics --verbose .

ruff:
  stage: pre
  image:
    name: alpine:edge
  extends: .display_env
  script:
    - apk add --no-cache ruff
    - ruff check --unsafe-fixes --diff || echo "!!! todo !!!"
    - ruff check --output-format=full
    - ruff check --select NPY201 --fix --diff || echo "!!! todo !!!"
    - ruff check --select NPY201 --output-format=full

.debian_based_test:
  stage: build_test
  extends: .display_env
  variables:
    PIP_INSTALL: "pip3 install --break-system-packages --user"
    PIP_UNINSTALL: "pip3 uninstall --yes --break-system-packages"
  script:
    - apt-get update
    - $APT_GET_INSTALL python3-numpy python3-opencv python3-pip
    - python3 --version
    - pip3 --version
    - $PIP_INSTALL .
    - ls -lah "$HOME"/.local/lib/*/site-packages/
    - export PATH="$PATH":~/.local/bin
    - detloclcheck find_checkerboard -h
    - $PIP_UNINSTALL DetLocLCheck
    - ls -lah "$HOME"/.local/lib/*/site-packages/
    - $APT_GET_INSTALL python3-pytest python3-pytest-cov python3-pytest-xdist
    - $PIP_INSTALL .
    - pytest-3 --numprocesses=auto --cov=detloclcheck --cov-report=html:coverage_report/ --cov-report=term --cov-report=xml --verbose tests/main.py
    - $PIP_UNINSTALL DetLocLCheck
    - $PIP_INSTALL -e .
    - detloclcheck find_checkerboard -h
    - $APT_GET_INSTALL make python3-recommonmark python3-sphinx python3-sphinx-argparse rsync
    - ./create_doc html
    - mv manual_detloclcheck public
  artifacts:
    expire_in: 1 hrs
    paths:
      - public

debian-latest:
  image:
    name: debian:latest
  extends: .debian_based_test
  coverage: '/^TOTAL\s*[0-9]+\s*[0-9]+\s*([0-9]+\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

ubuntu-2224:
  image:
    name: ubuntu:22.04
  extends: .debian_based_test
  variables:
    PIP_INSTALL: "pip3 install --user"
    PIP_UNINSTALL: "pip3 uninstall --yes"

ubuntu-2424:
  image:
    name: ubuntu:24.04
  extends: .debian_based_test
